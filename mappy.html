<html>
<head>
	<title>Leaflet Quick Start Guide Example</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.5/leaflet.css" />
  <script type="text/javascript" src="jsonp.js"></script>
<script type="text/javascript" src="sms.js"></script>    
<script type="text/javascript" src="endpoints/everyblock.js"></script>    
</head>
    
<body style="margin:0;padding:0;">
	<div id="map" style="width: 100%; height: 100%"></div>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
	<script src="http://cdn.leafletjs.com/leaflet-0.7.5/leaflet.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    
	<script>

var url = document.location.href
var zip = url.substr(url.length - 5);

  var parsed = parseURL(url);
  function parseURL(urlString) {
    var parser = document.createElement('a');
    parser.href = urlString;
    var obj = {
      protocol:parser.protocol,     // => "http:"
      hostname:parser.hostname,     // => "example.com"
      port:parser.port,           // => "3000"
      pathname:parser.pathname,     // => "/pathname/"
      search:parser.search,       // => "?search=test"
      hash:parser.hash,           // => "#hash"
      host:parser.host          // => "example.com:3000"
    };
    return obj;
  }

  var args = parsed.search.substr(1).split('&');

  for (var i = 0; i < args.length; i++) {
    var s = args[i].split('=');
    args[s[0]] = s[1];
  };

  var lat = args['lat'];
  var lon = args['lon'];

  if (!lat || !lon) {
    EveryBlock.latLonFromZIP(zip,function (data) {
      lat = data.lat;
      lon = data.lng;

      showMap();


    });
  } else {
    showMap();
  }


       function showMap() {
           var map = L.map('map').setView([lat,lon], 16);
          //var data = [];
          L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6IjZjNmRjNzk3ZmE2MTcwOTEwMGY0MzU3YjUzOWFmNWZhIn0.Y8bhBaUMqFiPrDRW9hieoQ', {
              maxZoom: 18,
              attribution: ' ',
              dragging: 'true',
              id: 'mapbox.streets',
          }).addTo(map); 
          var circle = L.circle([lat,lon], 10, {
             color: 'red',
             fillColor: '#f03',
             fillOpacity: 0.5
          }).addTo(map);

          window.EveryBlock.scanEvents(zip,function (parsed_json) {
          data=[];      
          data = parsed_json.results;
          console.log(data);
          data.forEach(function(d)
          {
            console.log(d);
            var str=d.attributes.item_datetime;
            console.log(str);  L.marker([d.location_coordinates[0].latitude,d.location_coordinates[0].longitude]).bindPopup(L.popup({maxWidth:500}).setContent('<Strong>'+"Event:"+'</Strong>'+d.title+'<br>'+'<Strong>'+"Venue:"+'</Strong>'+d.location_name+'<br>'+'<a target="_blank" class="popup" href="' + d.url + '">'+"More"+'</a>' )).addTo(map);
            
          });
        })

       }
        
// jQuery(document).ready(function($) {
//   $.ajax({
//   url : "https://api.everyblock.com/content/chicago/locations/60607/timeline/events/.json?token=818111003c3b49716d369cf290958441685e34c9",  
//   dataType : "json",
//   synchronous: "true",      
//   success : function(parsed_json) {
  
//   }
//   });
// });






Twilio.sendMessage('7816975494',"Satty");

    </script>
    
    </body>
</html>